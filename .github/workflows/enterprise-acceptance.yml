name: Enterprise Acceptance Pack

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  enterprise-acceptance:
    name: Enterprise E2E Acceptance (Simulation Mode)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: atlassian/forge-app/package-lock.json

      - name: Install dependencies
        working-directory: atlassian/forge-app
        run: npm ci

      - name: Run Enterprise Acceptance Pack (Simulation)
        env:
          MODE: SIMULATION
        run: |
          bash scripts/enterprise_e2e.sh
        continue-on-error: false

      - name: Check for forbidden write APIs
        run: |
          cd atlassian/forge-app
          # Fail if any POST/PUT/DELETE/PATCH found with requestJira
          if grep -r "requestJira.*POST\|requestJira.*PUT\|requestJira.*DELETE\|requestJira.*PATCH" src/; then
            echo "‚ùå FAIL: Found forbidden write API calls"
            exit 1
          fi
          echo "‚úÖ PASS: No write API calls found"

      - name: Check docs vs claims consistency
        run: |
          cd /home/runner/work/Firstry/Firstry
          node scripts/docs_guardrails.js || {
            echo "‚ö†Ô∏è  Docs guardrails found violations (expected in historical docs)"
            echo "Checking production-facing docs only..."
            
            # Check that privacy.html and terms.html pass
            if node scripts/docs_guardrails.js 2>&1 | grep -q "docs/privacy.html.*ERROR\|docs/terms.html.*ERROR"; then
              echo "‚ùå FAIL: Production legal docs have violations"
              exit 1
            fi
            
            echo "‚úÖ PASS: Production legal docs are compliant"
          }

      - name: Verify determinism (non-timestamp fields)
        working-directory: atlassian/forge-app
        run: |
          # Run credibility determinism test
          npm run test tests/credibility/gap5_determinism_10_runs.test.ts || {
            echo "‚ùå FAIL: Determinism check failed"
            exit 1
          }
          echo "‚úÖ PASS: Determinism verified"

      - name: Upload evidence bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: enterprise-acceptance-evidence
          path: audit_artifacts/enterprise_acceptance/
          retention-days: 90

      - name: Comment PR with summary (if PR)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Find latest evidence directory
            const baseDir = 'audit_artifacts/enterprise_acceptance';
            if (!fs.existsSync(baseDir)) {
              console.log('No evidence directory found');
              return;
            }
            
            const dirs = fs.readdirSync(baseDir).filter(d => d.match(/^\d{8}_\d{6}$/)).sort().reverse();
            if (dirs.length === 0) {
              console.log('No timestamped evidence directories found');
              return;
            }
            
            const latestDir = path.join(baseDir, dirs[0]);
            const summaryPath = path.join(latestDir, 'summary.md');
            
            if (!fs.existsSync(summaryPath)) {
              console.log('No summary.md found');
              return;
            }
            
            const summary = fs.readFileSync(summaryPath, 'utf-8');
            
            const comment = `## üè¢ Enterprise Acceptance Test Results\n\n${summary}\n\n---\nüì¶ **Evidence Bundle**: Download from workflow artifacts`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if any check failed
        run: |
          if [ -f audit_artifacts/enterprise_acceptance/latest/evidence_index.json ]; then
            FAIL_COUNT=$(jq '[.checks[] | select(.status == "FAIL")] | length' audit_artifacts/enterprise_acceptance/latest/evidence_index.json)
            
            if [ "$FAIL_COUNT" -gt 0 ]; then
              echo "‚ùå Enterprise acceptance pack has $FAIL_COUNT failed checks"
              exit 1
            fi
            
            echo "‚úÖ All enterprise acceptance checks passed"
          else
            echo "‚ùå Evidence index not found"
            exit 1
          fi
